<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Acceso Colaborador</title>
  <link rel="stylesheet" href="/estilos.css?v=3">
  <style>
    /* Small popup-specific adjustments */
    body { background: linear-gradient(180deg,#f7f7fb,#eef2f8); }
    .popup-container { max-width: 420px; margin: 18px auto; }
    #collab-message .message { margin-bottom: 12px; }
  </style>
</head>
<body>
  <main id="auth-content" class="popup-container">
    <div class="auth-logo-header">
      <img src="/logo.png" alt="GeoFem" class="auth-logo">
      <h1 class="auth-title">Acceso Colaborador</h1>
    </div>

    <div id="collab-message"></div>

    <form id="collab-login-form">
      <div class="form-group">
        <label for="collab-email">Email</label>
        <input type="email" id="collab-email" required placeholder="tucorreo@ejemplo.com">
      </div>
      <div class="form-group">
        <label for="collab-password">Contraseña</label>
        <input type="password" id="collab-password" required placeholder="Contraseña">
      </div>

      <button type="submit">Entrar como Colaborador</button>
    </form>

    <p style="font-size:12px;color:#666;margin-top:12px">Si las credenciales son incorrectas verás un mensaje; si persiste, tu acceso de editor puede estar en proceso.</p>
  </main>

  <script type="module">
    import { authenticateSupabase } from './authSupabase.js';

    const form = document.getElementById('collab-login-form');
    const msg = document.getElementById('collab-message');

    function showMessage(text, type = 'error') {
      msg.innerHTML = `<div class="message ${type}">${text}</div>`;
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('collab-email').value;
      const password = document.getElementById('collab-password').value;

      // Obtener credenciales de Supabase desde la ventana padre (auth.js expone getSupabaseCreds)
      let creds = null;
      try {
        if (window.opener && typeof window.opener.getSupabaseCreds === 'function') {
          creds = window.opener.getSupabaseCreds();
        }
      } catch (err) {
        console.error('No se pudo obtener credenciales de la ventana padre', err);
      }

      if (!creds || !creds.url || !creds.key) {
        showMessage('Error: credenciales de Supabase no disponibles', 'error');
        return;
      }

      showMessage('Autenticando...', 'info');
      const result = await authenticateSupabase(creds.url, creds.key, email, password);
      if (!result.success) {
        showMessage('Credenciales incorrectas. Si el error persiste, es posible que tu acceso de editor todavía se esté procesando.', 'error');
        return;
      }

      // Post message to opener to indicate success
      if (window.opener) {
        window.opener.postMessage({ type: 'collab-auth-success', email }, '*');
      }
      showMessage('Autenticación exitosa. Puedes cerrar esta ventana.', 'success');
    });
  </script>
</body>
</html>
